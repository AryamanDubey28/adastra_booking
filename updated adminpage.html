<!DOCTYPE html>
<html>

<head>
  <title>Admin Page</title>
  <style>
    th,
    td {
      border: 1px solid black;
      text-align: center;
    }
  </style>

  <!-- <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"> -->
  <link rel="stylesheet" href="admin_style.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

</head>

<body>
  <h2>Booking Requests</h2>
  <h3>Test Assessments</h3>

  <div id="testAssessmentTableContainer">
    <table id="testAssessmentTable"></table>

    <input id="testAssessmentRow" placeholder="Row"><br>
    <button id="testAssessmentAcceptButton">Accept</button>
    <button id="testAssessmentRejectButton">Reject</button>
    <p id="testAssessmentButtonText" style="margin-top: 0; color:red"></p>
  </div>

  <p id="testAssessmentTableText" style="margin-top: 0"></p>

  <h3>Crash Courses</h3>

  <div id="crashCourseTableContainer">
    <table id="crashCourseTable"></table>

    <input id="crashCourseRow" placeholder="Row"><br>
    <button id="crashCourseAcceptButton">Accept</button>
    <button id="crashCourseRejectButton">Reject</button>
    <p id="crashCourseButtonText" style="margin-top: 0; color:red"></p>
  </div>

  <p id="crashCourseTableText" style="margin-top: 0"></p>

  <h2>Add Available Booking</h2>
  <h3>Test Assessments</h3>

  <div id="testAssessmentCreateBookingContainer">
    <label for="testAssessmentDate">Date:</label>
    <input type="date" id="testAssessmentDate"><br>
    <p id="testAssessmentDateText" style="margin-top: 0; color:red"></p>
    <label for="testAssessmentTime">Time (e.g. 14:00):</label>
    <input type="text" id="testAssessmentTime"><br>
    <p id="testAssessmentTimeText" style="margin-top: 0; color:red"></p>
    <label for="testAssessmentLocation">Location:</label>
    <select id="testAssessmentLocation">
      <option value="Burnham Centre">Burnham Centre</option>
    </select><br><br>

    <button id="testAssessmentCreateBookingButton">Create Booking</button>
  </div>

  <p id="testAssessmentResultText"></p>

  <h3>Crash Courses</h3>

  <div id="crashCourseCreateBookingContainer">
    <label for="crashCourseDate">Date:</label>
    <input type="date" id="crashCourseDate"><br>
    <p id="crashCourseDateText" style="margin-top: 0; color:red"></p>
    <label for="crashCourseTime">Time (e.g. 14:00):</label>
    <input type="text" id="crashCourseTime"><br>
    <p id="crashCourseTimeText" style="margin-top: 0; color:red"></p>
    <label for="crashCourseLocation">Location:</label>
    <select id="crashCourseLocation">
      <option value="Burnham Centre">Burnham Centre</option>
    </select><br><br>

    <button id="crashCourseCreateBookingButton">Create Booking</button>
  </div>

  <p id="crashCourseResultText"></p>
  

  <script type="module">
    // Importing
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
    import { getDatabase, ref, get, set, child, update, remove }
      from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js"

    // Functions

    // Function to reformat the date because the date input gives it in the wrong format
    function formatDateFromInput(inputString) {
      var parts = inputString.split("-");
      var date = parts[2] + "-" + parts[1] + "-" + parts[0];
      return date;
    }

    // Function to convert the location into the format it is stored as in the title of the booking
    function replaceSpacesWithHyphens(inputString) {
      return inputString.replace(/ /g, "-");
    }

    function testAssessmentAcceptBooking() {
      var row = document.getElementById("testAssessmentRow").value;

      // If a valid row is entered then accept the request on that row
      if (row === "" || parseInt(row) > requests.length - 1 || parseInt(row) == 0) {
        testAssessmentButtonTextElement.textContent = "Please enter a valid row";
      } else {
        // Remove existing error messages
        testAssessmentButtonTextElement.textContent = "";

        // Update the database
        var firstName = requests[row][0];
        var lastName = requests[row][1];
        var email = requests[row][2];
        var comment = requests[row][3];
        var location = requests[row][4];
        var date = requests[row][5];
        var time = requests[row][6];

        set(ref(db, "test-assessments/" + date + ";" + time + ";" + replaceSpacesWithHyphens(location)), {
          "first-name": firstName,
          "last-name": lastName,
          "email": email,
          "comment": comment,
          "status": "accepted",
          "location": location,
          "date": date,
          "time": time
        })

        // Set the row green
        var rows = document.querySelectorAll("#testAssessmentTable tr");

        var rowCells = rows[row].querySelectorAll("td");
        rowCells.forEach(function (cell) {
          cell.style.color = "green";
          cell.style.fontWeight = "bold";
        });

        // Clear the row input
        document.getElementById("testAssessmentRow").value = "";

        // Compose an email
        var subject = "Test Assessment Response";
        var body = "Hi " + firstName + ",\n\nYour request for a booking on " + date + " at " + time + " in " + location + " has been accepted. We look forward to seeing you.\n\nRegards,\nAd Astra Tuition";

        var mailtoURL = "mailto:" + encodeURIComponent(email) +
          "?subject=" + encodeURIComponent(subject) +
          "&body=" + encodeURIComponent(body);

        window.open(mailtoURL);
      }
    }

    function crashCourseAcceptBooking() {
      var row = document.getElementById("crashCourseRow").value;

      // If a valid row is entered then accept the request on that row
      if (row === "" || parseInt(row) > requests.length - 1 || parseInt(row) == 0) {
        crashCourseButtonTextElement.textContent = "Please enter a valid row";
      } else {
        // Remove existing error messages
        crashCourseButtonTextElement.textContent = "";

        // Update the database
        var firstName = requests[row][0];
        var lastName = requests[row][1];
        var email = requests[row][2];
        var comment = requests[row][3];
        var location = requests[row][4];
        var date = requests[row][5];
        var time = requests[row][6];

        set(ref(db, "crash-courses/" + date + ";" + time + ";" + replaceSpacesWithHyphens(location)), {
          "first-name": firstName,
          "last-name": lastName,
          "email": email,
          "comment": comment,
          "status": "accepted",
          "location": location,
          "date": date,
          "time": time
        })

        // Set the row green
        var rows = document.querySelectorAll("#crashCourseTable tr");

        var rowCells = rows[row].querySelectorAll("td");
        rowCells.forEach(function (cell) {
          cell.style.color = "green";
          cell.style.fontWeight = "bold";
        });

        // Clear the row input
        document.getElementById("crashCourseRow").value = "";

        // Compose an email
        var subject = "Crash Course Response";
        var body = "Hi " + firstName + ",\n\nYour request for a booking on " + date + " at " + time + " in " + location + " has been accepted. We look forward to seeing you.\n\nRegards,\nAd Astra Tuition";

        var mailtoURL = "mailto:" + encodeURIComponent(email) +
          "?subject=" + encodeURIComponent(subject) +
          "&body=" + encodeURIComponent(body);

        window.open(mailtoURL);
      }
    }

    function testAssessmentRejectBooking() {
      var row = document.getElementById("testAssessmentRow").value;

      // If a valid row is entered then reject the request on that row
      if (row === "" || parseInt(row) > requests.length - 1 || parseInt(row) == 0) {
        testAssessmentButtonTextElement.textContent = "Please enter a valid row";
      } else {
        // Remove existing error messages
        testAssessmentButtonTextElement.textContent = "";

        // Update the database
        var location = requests[row][4];
        var date = requests[row][5];
        var time = requests[row][6];

        set(ref(db, "test-assessments/" + date + ";" + time + ";" + replaceSpacesWithHyphens(location)), {
          "status": "available",
          "location": location,
          "date": date,
          "time": time
        })

        // Set the row red
        var rows = document.querySelectorAll("#myTable tr");

        var rowCells = rows[row].querySelectorAll("td");
        rowCells.forEach(function (cell) {
          cell.style.color = "red";
          cell.style.fontWeight = "bold";
        });

        // Clear the row input
        document.getElementById("testAssessmentRow").value = "";

        // Compose an email
        var firstName = requests[row][0];
        var email = requests[row][2];

        var subject = "Test Assessment Response";
        var body = "Hi " + firstName + ",\n\nUnfortunately, your request for a booking on " + date + " at " + time + " in " + location + " has been rejected. Please try and request another time.\n\nRegards,\nAd Astra";

        var mailtoURL = "mailto:" + encodeURIComponent(email) +
          "?subject=" + encodeURIComponent(subject) +
          "&body=" + encodeURIComponent(body);

        window.open(mailtoURL);
      }
    }

    function crashCourseRejectBooking() {
      var row = document.getElementById("crashCourseRow").value;

      // If a valid row is entered then reject the request on that row
      if (row === "" || parseInt(row) > requests.length - 1 || parseInt(row) == 0) {
        crashCourseButtonTextElement.textContent = "Please enter a valid row";
      } else {
        // Remove existing error messages
        crashCourseButtonTextElement.textContent = "";

        // Update the database
        var location = requests[row][4];
        var date = requests[row][5];
        var time = requests[row][6];

        set(ref(db, "crash-courses/" + date + ";" + time + ";" + replaceSpacesWithHyphens(location)), {
          "status": "available",
          "location": location,
          "date": date,
          "time": time
        })

        // Set the row red
        var rows = document.querySelectorAll("#crashCourseTable tr");

        var rowCells = rows[row].querySelectorAll("td");
        rowCells.forEach(function (cell) {
          cell.style.color = "red";
          cell.style.fontWeight = "bold";
        });

        // Clear the row input
        document.getElementById("crashCourseRow").value = "";

        // Compose an email
        var firstName = requests[row][0];
        var email = requests[row][2];

        var subject = "Crash Course Response";
        var body = "Hi " + firstName + ",\n\nUnfortunately, your request for a booking on " + date + " at " + time + " in " + location + " has been rejected. Please try and request another time.\n\nRegards,\nAd Astra";

        var mailtoURL = "mailto:" + encodeURIComponent(email) +
          "?subject=" + encodeURIComponent(subject) +
          "&body=" + encodeURIComponent(body);

        window.open(mailtoURL);
      }
    }

    function testAssessmentInsertBooking() {
      var date = formatDateFromInput(document.getElementById("testAssessmentDate").value);
      var time = document.getElementById("testAssessmentTime").value;
      var location = document.getElementById("testAssessmentLocation").value;

      set(ref(db, "test-assessments/" + date + ";" + time + ";" + replaceSpacesWithHyphens(location)), {
        "status": "available",
        "location": location,
        "date": date,
        "time": time
      })

      testAssessmentResultTextElement.style.color = "green";
      testAssessmentResultTextElement.textContent = "Added available test assessment booking on " + date + " at " + time + " in " + location + ".";
      document.getElementById("testAssessmentTime").value = "";
    }

    function crashCourseInsertBooking() {
      var date = formatDateFromInput(document.getElementById("crashCourseDate").value);
      var time = document.getElementById("crashCourseTime").value;
      var location = document.getElementById("crashCourseLocation").value;

      set(ref(db, "crash-courses/" + date + ";" + time + ";" + replaceSpacesWithHyphens(location)), {
        "status": "available",
        "location": location,
        "date": date,
        "time": time
      })

      crashCourseResultTextElement.style.color = "green";
      crashCourseResultTextElement.textContent = "Added available crash course booking on " + date + " at " + time + " in " + location + ".";
      document.getElementById("crashCourseTime").value = "";
    }

    function testAssessmentProcessInputs() {
      var allInfoFilledCorrectly = true;

      var unformattedDate = document.getElementById("testAssessmentDate").value;
      var parts = unformattedDate.split("-");
      var date = parts[2] + "-" + parts[1] + "-" + parts[0];

      if (date === "") {
        testAssessmentDateTextElement.textContent = "Please select a date";
        allInfoFilledCorrectly = false;
      } else {
        testAssessmentDateTextElement.textContent = "";
      }

      var time = document.getElementById("testAssessmentTime").value;

      if (time === "") {
        timeTextElement.textContent = "Please enter a time";
        allInfoFilledCorrectly = false;
      } else {
        testAssessmentTimeTextElement.textContent = "";
      }

      if (allInfoFilledCorrectly === true) {
        testAssessmentInsertBooking();
      } else {
        testAssessmentResultTextElement.textContent = "";
      }
    }

    function crashCourseProcessInputs() {
      var allInfoFilledCorrectly = true;

      var unformattedDate = document.getElementById("crashCourseDate").value;
      var parts = unformattedDate.split("-");
      var date = parts[2] + "-" + parts[1] + "-" + parts[0];

      if (date === "") {
        crashCourseDateTextElement.textContent = "Please select a date";
        allInfoFilledCorrectly = false;
      } else {
        crashCourseDateTextElement.textContent = "";
      }

      var time = document.getElementById("crashCourseTime").value;

      if (time === "") {
        timeTextElement.textContent = "Please enter a time";
        allInfoFilledCorrectly = false;
      } else {
        crashCourseTimeTextElement.textContent = "";
      }

      if (allInfoFilledCorrectly === true) {
        crashCourseInsertBooking();
      } else {
        crashCourseResultTextElement.textContent = "";
      }
    }

    // Create all of the variables which will be accessed by function
    var testAssessmentTableContainerElement = document.getElementById("testAssessmentTableContainer")
    var testAssessmentTableElement = document.getElementById("testAssessmentTable");
    var testAssessmentTableTextElement = document.getElementById("testAssessmentTableText");
    var testAssessmentAcceptButton = document.getElementById("testAssessmentAcceptButton");
    var testAssessmentRejectButton = document.getElementById("testAssessmentRejectButton");
    var testAssessmentButtonTextElement = document.getElementById("testAssessmentButtonText");

    var crashCourseTableContainerElement = document.getElementById("crashCourseTableContainer")
    var crashCourseTableElement = document.getElementById("crashCourseTable");
    var crashCourseTableTextElement = document.getElementById("crashCourseTableText");
    var crashCourseAcceptButton = document.getElementById("crashCourseAcceptButton");
    var crashCourseRejectButton = document.getElementById("crashCourseRejectButton");
    var crashCourseButtonTextElement = document.getElementById("crashCourseButtonText");


    var testAssessmentDateTextElement = document.getElementById("testAssessmentDateText");
    var testAssessmentTimeTextElement = document.getElementById("testAssessmentTimeText");
    var testAssessmentLocationTextElement = document.getElementById("testAssessmentLocationText");
    var testAssessmentCreateBookingButton = document.getElementById("testAssessmentCreateBookingButton");
    var testAssessmentResultTextElement = document.getElementById("testAssessmentResultText");

    var crashCourseDateTextElement = document.getElementById("crashCourseDateText");
    var crashCourseTimeTextElement = document.getElementById("crashCourseTimeText");
    var crashCourseLocationTextElement = document.getElementById("crashCourseLocationText");
    var crashCourseCreateBookingButton = document.getElementById("crashCourseCreateBookingButton");
    var crashCourseResultTextElement = document.getElementById("crashCourseResultText");

    // Access the database
    var firebaseConfig = {
      apiKey: "AIzaSyCbo5IPc1TL0rKKcG16BYBI2bRueYof8rc",
      authDomain: "ad-astra-test1.firebaseapp.com",
      databaseURL: "https://ad-astra-test1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "ad-astra-test1",
      storageBucket: "ad-astra-test1.appspot.com",
      messagingSenderId: "754196429203",
      appId: "1:754196429203:web:e192d5608e0c3ef1005066"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase();
    const dbref = ref(db);

    // Fill the test assessment table with the requested bookings
    var requests = [
      ["First Name", "Last Name", "Email", "Comment", "Location", "Date", "Time", "Row"]
    ];

    get(child(dbref, "test-assessments/"))
      .then((snapshot) => {
        snapshot.forEach(child => {
          if (child.val().status == "requested") {
            var firstName = child.val()["first-name"];
            var lastName = child.val()["last-name"];
            var email = child.val().email;
            var comment = child.val().comment;
            var location = child.val().location;
            var date = child.val().date;
            var time = child.val().time;

            requests.push([firstName, lastName, email, comment, location, date, time])
          }
        });
        // If requests exist then create the table showing all their details and set up the buttons
        if (requests.length > 1) {
          // Create table rows and cells from the 2D array
          for (var i = 0; i < requests.length; i++) {
            var row = testAssessmentTableElement.insertRow();
            for (var j = 0; j < requests[0].length; j++) {
              var cell = row.insertCell();
              if (j != requests[0].length - 1 || i == 0) {
                cell.innerHTML = requests[i][j];
              } else {
                cell.innerHTML = i;
              }
            }
          }
        } else {
          testAssessmentTableContainerElement.style.display = "none";
          testAssessmentTableTextElement.textContent = "No booking requests";
        }
      })

    // Fill the crash course table with the requested bookings
    var requests = [
      ["First Name", "Last Name", "Email", "Comment", "Location", "Date", "Time", "Row"]
    ];

    get(child(dbref, "crash-courses/"))
      .then((snapshot) => {
        snapshot.forEach(child => {
          if (child.val().status == "requested") {
            var firstName = child.val()["first-name"];
            var lastName = child.val()["last-name"];
            var email = child.val().email;
            var comment = child.val().comment;
            var location = child.val().location;
            var date = child.val().date;
            var time = child.val().time;

            requests.push([firstName, lastName, email, comment, location, date, time])
          }
        });
        // If requests exist then create the table showing all their details and set up the buttons
        if (requests.length > 1) {
          // Create table rows and cells from the 2D array
          for (var i = 0; i < requests.length; i++) {
            var row = crashCourseTableElement.insertRow();
            for (var j = 0; j < requests[0].length; j++) {
              var cell = row.insertCell();
              if (j != requests[0].length - 1 || i == 0) {
                cell.innerHTML = requests[i][j];
              } else {
                cell.innerHTML = i;
              }
            }
          }
        } else {
          crashCourseTableContainerElement.style.display = "none";
          crashCourseTableTextElement.textContent = "No booking requests";
        }
      })

    testAssessmentAcceptButton.addEventListener("click", testAssessmentAcceptBooking);
    testAssessmentRejectButton.addEventListener("click", testAssessmentRejectBooking);

    testAssessmentCreateBookingButton.addEventListener("click", testAssessmentProcessInputs);
    
    crashCourseAcceptButton.addEventListener("click", crashCourseAcceptBooking);
    crashCourseRejectButton.addEventListener("click", crashCourseRejectBooking);

    crashCourseCreateBookingButton.addEventListener("click", crashCourseProcessInputs);
  </script>
</body>

</html>